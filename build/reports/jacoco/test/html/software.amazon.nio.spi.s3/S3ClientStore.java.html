<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>S3ClientStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">s3fs-spi</a> &gt; <a href="index.source.html" class="el_package">software.amazon.nio.spi.s3</a> &gt; <span class="el_source">S3ClientStore.java</span></div><h1>S3ClientStore.java</h1><pre class="source lang-java linenums">/*
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

package software.amazon.nio.spi.s3;


import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import software.amazon.awssdk.core.exception.ApiCallAttemptTimeoutException;
import software.amazon.awssdk.core.exception.ApiCallTimeoutException;
import software.amazon.awssdk.core.exception.RetryableException;
import software.amazon.awssdk.core.retry.backoff.EqualJitterBackoffStrategy;
import software.amazon.awssdk.core.retry.conditions.*;
import software.amazon.awssdk.http.HttpStatusCode;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3AsyncClient;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.HeadBucketResponse;
import software.amazon.awssdk.services.s3.model.S3Exception;

import java.io.IOException;
import java.net.URI;
import java.time.Duration;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

/**
 * A Singleton cache of clients for buckets configured for the region of those buckets
 */
public class S3ClientStore {

<span class="nc" id="L35">    private static final S3ClientStore instance = new S3ClientStore();</span>

<span class="nc" id="L37">    public static final S3Client DEFAULT_CLIENT = S3Client.builder()</span>
<span class="nc" id="L38">            .endpointOverride(URI.create(&quot;https://s3.us-east-1.amazonaws.com&quot;))</span>
<span class="nc" id="L39">            .region(Region.US_EAST_1)</span>
<span class="nc" id="L40">            .build();</span>

<span class="nc" id="L42">    public static final S3AsyncClient DEFAULT_ASYNC_CLIENT = S3AsyncClient.builder()</span>
<span class="nc" id="L43">            .endpointOverride(URI.create(&quot;https://s3.us-east-1.amazonaws.com&quot;))</span>
<span class="nc" id="L44">            .region(Region.US_EAST_1)</span>
<span class="nc" id="L45">            .build();</span>

<span class="nc" id="L47">    private final Map&lt;String, S3Client&gt; bucketToClientMap = Collections.synchronizedMap(new HashMap&lt;&gt;());</span>
<span class="nc" id="L48">    private final Map&lt;String, S3AsyncClient&gt; bucketToAsyncClientMap = Collections.synchronizedMap(new HashMap&lt;&gt;());</span>

<span class="nc" id="L50">    private final EqualJitterBackoffStrategy backoffStrategy = EqualJitterBackoffStrategy.builder()</span>
<span class="nc" id="L51">            .baseDelay(Duration.ofMillis(200L))</span>
<span class="nc" id="L52">            .maxBackoffTime(Duration.ofSeconds(5L))</span>
<span class="nc" id="L53">            .build();</span>

    final RetryCondition retryCondition;

    {
<span class="nc" id="L58">        final Set&lt;Integer&gt; RETRYABLE_STATUS_CODES = Stream.of(</span>
<span class="nc" id="L59">                HttpStatusCode.INTERNAL_SERVER_ERROR,</span>
<span class="nc" id="L60">                HttpStatusCode.BAD_GATEWAY,</span>
<span class="nc" id="L61">                HttpStatusCode.SERVICE_UNAVAILABLE,</span>
<span class="nc" id="L62">                HttpStatusCode.GATEWAY_TIMEOUT</span>
<span class="nc" id="L63">        ).collect(Collectors.toSet());</span>

<span class="nc" id="L65">        final Set&lt;Class&lt;? extends Exception&gt;&gt; RETRYABLE_EXCEPTIONS = Stream.of(</span>
                RetryableException.class,
                IOException.class,
                ApiCallAttemptTimeoutException.class,
<span class="nc" id="L69">                ApiCallTimeoutException.class).collect(Collectors.toSet());</span>

<span class="nc" id="L71">        retryCondition = OrRetryCondition.create(</span>
<span class="nc" id="L72">                RetryOnStatusCodeCondition.create(RETRYABLE_STATUS_CODES),</span>
<span class="nc" id="L73">                RetryOnExceptionsCondition.create(RETRYABLE_EXCEPTIONS),</span>
<span class="nc" id="L74">                RetryOnClockSkewCondition.create(),</span>
<span class="nc" id="L75">                RetryOnThrottlingCondition.create()</span>
        );
    }

<span class="nc" id="L79">    Logger logger = LoggerFactory.getLogger(&quot;S3ClientStore&quot;);</span>

<span class="nc" id="L81">    private S3ClientStore(){}</span>

<span class="nc" id="L83">    public static S3ClientStore getInstance() { return instance; }</span>

    public S3Client getClientForBucketName( String bucketName ) {
<span class="nc" id="L86">        logger.debug(&quot;obtaining client for bucket '{}'&quot;, bucketName);</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">        if (bucketName == null || bucketName.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L88">            return DEFAULT_CLIENT;</span>
        }

<span class="nc" id="L91">        return bucketToClientMap.computeIfAbsent(bucketName, this::generateClient);</span>
    }

    public S3AsyncClient getAsyncClientForBucketName( String bucketName ) {
<span class="nc" id="L95">        logger.debug(&quot;obtaining async client for bucket '{}'&quot;, bucketName);</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (bucketName == null || bucketName.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L97">            return DEFAULT_ASYNC_CLIENT;</span>
        }

<span class="nc" id="L100">        return bucketToAsyncClientMap.computeIfAbsent(bucketName, this::generateAsyncClient);</span>
    }

    /**
     * Generate a client for the named bucket using a default client to determine the location of the named client
     * @param bucketName the named of the bucket to make the client for
     * @return an S3 client appropriate for the region of the named bucket
     */
    protected S3Client generateClient(String bucketName){
<span class="nc" id="L109">        return this.generateClient(bucketName, DEFAULT_CLIENT);</span>
    }

    protected S3AsyncClient generateAsyncClient(String bucketName){
<span class="nc" id="L113">        return this.generateAsyncClient(bucketName, DEFAULT_CLIENT);</span>
    }

    /**
     * Generate a client for the named bucket using a default client to determine the location of the named client
     * @param bucketName the named of the bucket to make the client for
     * @param locationClient the client used to determine the location of the named bucket, recommend using DEFAULT_CLIENT
     * @return an S3 client appropriate for the region of the named bucket
     */
    protected S3Client generateClient (String bucketName, S3Client locationClient) {
<span class="nc" id="L123">        logger.debug(&quot;generating client for bucket: '{}'&quot;, bucketName);</span>
        S3Client bucketSpecificClient;
        try {
<span class="nc" id="L126">            logger.debug(&quot;determining bucket location with getBucketLocation&quot;);</span>
<span class="nc" id="L127">            String bucketLocation = locationClient.getBucketLocation(builder -&gt; builder.bucket(bucketName)).locationConstraintAsString();</span>

<span class="nc" id="L129">            bucketSpecificClient = this.clientForRegion(bucketLocation);</span>

<span class="nc" id="L131">        } catch (S3Exception e) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if(e.statusCode() == 403) {</span>
<span class="nc" id="L133">                logger.debug(&quot;Cannot determine location of '{}' bucket directly. Attempting to obtain bucket location with headBucket operation&quot;, bucketName);</span>
                try {
<span class="nc" id="L135">                    final HeadBucketResponse headBucketResponse = locationClient.headBucket(builder -&gt; builder.bucket(bucketName));</span>
<span class="nc" id="L136">                    bucketSpecificClient = this.clientForRegion(headBucketResponse.</span>
<span class="nc" id="L137">                            sdkHttpResponse()</span>
<span class="nc" id="L138">                            .firstMatchingHeader(&quot;x-amz-bucket-region&quot;)</span>
<span class="nc" id="L139">                            .orElseThrow(() -&gt; new NoSuchElementException(&quot;Head Bucket Response doesn't include the header 'x-amz-bucket-region'&quot;)));</span>
<span class="nc" id="L140">                } catch (S3Exception e2) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                    if (e2.statusCode() == 301) {</span>
<span class="nc" id="L142">                        bucketSpecificClient = this.clientForRegion(e2.awsErrorDetails().</span>
<span class="nc" id="L143">                                sdkHttpResponse()</span>
<span class="nc" id="L144">                                .firstMatchingHeader(&quot;x-amz-bucket-region&quot;)</span>
<span class="nc" id="L145">                                .orElseThrow(() -&gt; new NoSuchElementException(&quot;Head Bucket Response doesn't include the header 'x-amz-bucket-region'&quot;)));</span>
                    } else {
<span class="nc" id="L147">                        throw e2;</span>
                    }
<span class="nc" id="L149">                }</span>
            } else {
<span class="nc" id="L151">                throw e;</span>
            }
<span class="nc" id="L153">        }</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (bucketSpecificClient == null) {</span>
<span class="nc" id="L156">            logger.warn(&quot;Unable to determine the region of bucket: '{}'. Generating a client for the profile region.&quot;, bucketName);</span>
<span class="nc" id="L157">            bucketSpecificClient = S3Client.builder()</span>
<span class="nc" id="L158">                    .overrideConfiguration(conf -&gt; conf.retryPolicy(builder -&gt; builder</span>
<span class="nc" id="L159">                        .retryCondition(retryCondition)</span>
<span class="nc" id="L160">                        .backoffStrategy(backoffStrategy)))</span>
<span class="nc" id="L161">                    .build();</span>
        }

<span class="nc" id="L164">        return bucketSpecificClient;</span>
    }

    /**
     * Generate an asynchronouse client for the named bucket using a default client to determine the location of the named client
     * @param bucketName the named of the bucket to make the client for
     * @param locationClient the client used to determine the location of the named bucket, recommend using DEFAULT_CLIENT
     * @return an S3 client appropriate for the region of the named bucket
     */
    protected S3AsyncClient generateAsyncClient (String bucketName, S3Client locationClient) {
<span class="nc" id="L174">        logger.debug(&quot;generating asynchronous client for bucket: '{}'&quot;, bucketName);</span>
        S3AsyncClient bucketSpecificClient;
        try {
<span class="nc" id="L177">            logger.debug(&quot;determining bucket location with getBucketLocation&quot;);</span>
<span class="nc" id="L178">            String bucketLocation = locationClient.getBucketLocation(builder -&gt; builder.bucket(bucketName)).locationConstraintAsString();</span>

<span class="nc" id="L180">            bucketSpecificClient = this.asyncClientForRegion(bucketLocation);</span>

<span class="nc" id="L182">        } catch (S3Exception e) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if(e.statusCode() == 403) {</span>
<span class="nc" id="L184">                logger.debug(&quot;Cannot determine location of '{}' bucket directly. Attempting to obtain bucket location with headBucket operation&quot;, bucketName);</span>
                try {
<span class="nc" id="L186">                    final HeadBucketResponse headBucketResponse = locationClient.headBucket(builder -&gt; builder.bucket(bucketName));</span>
<span class="nc" id="L187">                    bucketSpecificClient = this.asyncClientForRegion(headBucketResponse.sdkHttpResponse()</span>
<span class="nc" id="L188">                            .firstMatchingHeader(&quot;x-amz-bucket-region&quot;)</span>
<span class="nc" id="L189">                            .orElseThrow(() -&gt; new NoSuchElementException(&quot;Head Bucket Response doesn't include the header 'x-amz-bucket-region'&quot;)));</span>
<span class="nc" id="L190">                } catch (S3Exception e2) {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                    if (e2.statusCode() == 301) {</span>
<span class="nc" id="L192">                        bucketSpecificClient = this.asyncClientForRegion(e2</span>
<span class="nc" id="L193">                                .awsErrorDetails()</span>
<span class="nc" id="L194">                                .sdkHttpResponse()</span>
<span class="nc" id="L195">                                .firstMatchingHeader(&quot;x-amz-bucket-region&quot;)</span>
<span class="nc" id="L196">                                .orElseThrow(() -&gt; new NoSuchElementException(&quot;Head Bucket Response doesn't include the header 'x-amz-bucket-region'&quot;)));</span>
                    } else {
<span class="nc" id="L198">                        throw e2;</span>
                    }
<span class="nc" id="L200">                }</span>
            } else {
<span class="nc" id="L202">                throw e;</span>
            }
<span class="nc" id="L204">        }</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (bucketSpecificClient == null) {</span>
<span class="nc" id="L207">            logger.warn(&quot;Unable to determine the region of bucket: '{}'. Generating a client for the profile region.&quot;, bucketName);</span>
<span class="nc" id="L208">            bucketSpecificClient = S3AsyncClient.builder()</span>
<span class="nc" id="L209">                    .overrideConfiguration(conf -&gt; conf.retryPolicy(builder -&gt; builder</span>
<span class="nc" id="L210">                            .retryCondition(retryCondition)</span>
<span class="nc" id="L211">                            .backoffStrategy(backoffStrategy)))</span>
<span class="nc" id="L212">                    .build();</span>
        }

<span class="nc" id="L215">        return bucketSpecificClient;</span>
    }

    private S3Client clientForRegion(String regionString){
        // It may be useful to further cache clients for regions although at some point clients for buckets may need to be
        // specialized beyond just region end points.
<span class="nc bnc" id="L221" title="All 2 branches missed.">        Region region = regionString.equals(&quot;&quot;) ? Region.US_EAST_1 : Region.of(regionString);</span>
<span class="nc" id="L222">        logger.debug(&quot;bucket region is: '{}'&quot;, region.id());</span>

<span class="nc" id="L224">        return S3Client.builder()</span>
<span class="nc" id="L225">                .region(region)</span>
<span class="nc" id="L226">                .overrideConfiguration(conf -&gt; conf.retryPolicy(builder -&gt; builder</span>
<span class="nc" id="L227">                        .retryCondition(retryCondition)</span>
<span class="nc" id="L228">                        .backoffStrategy(backoffStrategy)))</span>
<span class="nc" id="L229">                .build();</span>
    }

    private S3AsyncClient asyncClientForRegion(String regionString){
        // It may be useful to further cache clients for regions although at some point clients for buckets may need to be
        // specialized beyond just region end points.
<span class="nc bnc" id="L235" title="All 2 branches missed.">        Region region = regionString.equals(&quot;&quot;) ? Region.US_EAST_1 : Region.of(regionString);</span>
<span class="nc" id="L236">        logger.debug(&quot;bucket region is: '{}'&quot;, region.id());</span>

<span class="nc" id="L238">        return S3AsyncClient.builder()</span>
<span class="nc" id="L239">                .region(region)</span>
<span class="nc" id="L240">                .overrideConfiguration(conf -&gt; conf.retryPolicy(builder -&gt; builder</span>
<span class="nc" id="L241">                        .retryCondition(retryCondition)</span>
<span class="nc" id="L242">                        .backoffStrategy(backoffStrategy)))</span>
<span class="nc" id="L243">                .build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>